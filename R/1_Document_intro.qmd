---
title: "Premières inspections des données"
format: pdf
---




# Read raw data


```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(dplyr)
library(readr)
library(ggplot2)
theme_set(theme_bw())
library(tidyr)

library(signal)

conflicted::conflicts_prefer(dplyr::filter, dplyr::select)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```



# Présentation des données NIRS


Données issues du travail de thèse de Marianne Laurençon, récupérées [ici](https://entrepot.recherche.data.gouv.fr/dataset.xhtml?persistentId=doi:10.57745/6VYUQN).

```{r}


data_NIRS_raw <- read_csv2("data/NIRS_data/Full_dataset.csv")


```

```{r read and set data}

fun_convert_num = function(x){
  x = stringr::str_replace(x, ',', '.' )
  return(as.numeric(x))
}


# Set data (transform wavelength in number and so on)
data_NIRS <- data_NIRS_raw %>% 
  select(Sample_ID, Accession, `N regime`, `W regime`, Tissue, `12489,6`:`3594,9`) %>% 
  pivot_longer(-c(Sample_ID:Tissue), names_to = "Wavenumber",
               values_to = "Absorbance", 
               names_transform = fun_convert_num)%>% 
  arrange(Sample_ID, Wavenumber) %>% 
  mutate(Absorbance_SNV = (Absorbance - mean(Absorbance))/sd(Absorbance), .by = Sample_ID)  %>% 
  mutate(Absorbance_SG_0 = sgolayfilt(Absorbance_SNV, p = 3)) %>% 
  mutate(Absorbance_SG_1 = sgolayfilt(Absorbance_SNV, p = 3, m = 1)) 

data_NIRS$Sample_ID <- as.factor(data_NIRS$Sample_ID)
data_NIRS$Accession <- as.factor(data_NIRS$Accession)
data_NIRS$`N regime` <- as.factor(data_NIRS$`N regime`)
data_NIRS$`W regime` <- as.factor(data_NIRS$`W regime`)
data_NIRS$Tissue <- as.factor(data_NIRS$Tissue)

# subsample to make plots quicker
id_train = data_NIRS %>% 
  distinct(Sample_ID, Accession, `N regime`, `W regime`, Tissue ) %>% 
  slice_sample(prop = .1, by = c(Accession, `N regime`, `W regime`, Tissue) ) %>% 
  select(Sample_ID)


data_plot = data_NIRS %>% 
  inner_join(id_train)

# création d'un vecteur des différentes longueur d'ondes.
wavelength <- data_NIRS %>% filter(Sample_ID == "15_N1S1_03-19_Res_1") %>% arrange(-Wavenumber) %>%  select(Wavenumber) %>% as.matrix() %>% as.vector()


```


# Plot data


## Raw

Voici une représentation des données NIRS brutes.

```{r}

plot_raw = data_plot %>% 
  ggplot(aes(x = Wavenumber, y = Absorbance)) +
  geom_line(aes(group = Sample_ID, color = `N regime`), alpha = .3) + 
  facet_wrap(Tissue ~ . ) +
  theme(legend.position = 'bottom') +
  labs(x = latex2exp::TeX("Wavenumber ($cm^{-1}$)"))


plot_raw

```



## SNV


```{r}

plot_SNV =  data_plot %>% 
  ggplot(aes(x = Wavenumber, y = Absorbance_SNV)) +
  geom_line(aes(group = Sample_ID, color = `N regime`), alpha = .3) + 
  facet_wrap(Tissue ~ . ) +
  theme(legend.position = 'bottom') +
  labs(x = latex2exp::TeX("Wavenumber ($cm^{-1}$)"))


plot_SNV


# data_plot %>% 
#   pivot_longer(c(Absorbance, Absorbance_SNV), names_to = "Absorbance", values_to = "value_absorbance") %>% 
#   ggplot(aes(x = Wavenumber, y = value_absorbance)) +
#   geom_line(aes(group = interaction(Sample_ID, Absorbance), color = Absorbance), alpha = .3) + 
#   facet_wrap(Tissue ~ . ) +
#   theme(legend.position = 'bottom') +
#   labs(x = latex2exp::TeX("Wavenumber ($cm^{-1}$)"))
```



## Savitzky-Golay filter



De nombreux travaux appliquent par défaut un filtre sur les données NIRS appelé Savitzky-Golay. Recherchez le principe de ce filtre et jouez avec les différents paramètres de la fonction `sgolayfilt`.



```{r, fig.height=7}

library(patchwork)

plot_SG0 <- data_plot %>%
  ggplot(aes(x = Wavenumber, y = Absorbance_SG_0)) +
  geom_line(aes(group = Sample_ID, color = `N regime`), alpha = .3) + 
  facet_wrap(Tissue ~ . ) +
  theme(legend.position = 'bottom') +
  labs(x = latex2exp::TeX("Wavenumber ($cm^{-1}$)"), title = "Savitzky-Golay, no derivative")


plot_SG1 <-  data_plot %>% 
  ggplot(aes(x = Wavenumber, y = Absorbance_SG_1)) +
  geom_line(aes(group = Sample_ID, color = `N regime`), alpha = .3) + 
  facet_wrap(Tissue ~ . ) +
  theme(legend.position = 'bottom') +
  labs(x = latex2exp::TeX("Wavenumber ($cm^{-1}$)"), title = "Savitzky-Golay, first derivative")


plot_SG0 / plot_SG1

```



# A faire sur ces premiers jours


## Prendre en main les données NIRS

* Lire les chapitres III (III.1 et III.3) et IV de la thèse de Marianne Laurençon.
* Explorer les donnnées: présence d'outliers ? Des individus aberrants ? Réaliser description des données en votre disposition (effectifs, équilibre, covariables etc.)
* Réaliser quelques visualisations (données fonctionnelles et scalaires)
* Noter toutes les questions que je dois poser à Anne Laperche le 28/11

__Rendu__

* Un document avec la description des données et les (potentielles) questions que vous avez

## Prendre en main les méthodes de données fonctionnelles


* Lire les liens suivants:
  + [intro à la FDA](https://arxiv.org/html/2404.16598v1)
  + [ACP fonctionnelle](https://towardsdatascience.com/functional-principal-component-analysis-and-functional-data-91d21261ab7f/) et/ou [ce lien](https://onlinelibrary.wiley.com/doi/10.1002/hbm.20074)
  + [FDA sur R en utilisant refund](https://www.psychoco.org/2020/slides/Reiss.pdf)
  + [FDA sur R en utilisant fda](https://rviews.rstudio.com/2021/05/04/functional-data-analysis-in-r/)
  

* Appliquer certaines des méthodes vues sur les données NIRS
  + Ex. Y = N content, X = NIRS
  + ACP sur données NIRS

__Rendu__

* Quelques premières analyses sur les données NIRS. Comparaison avec d'autres méthodes (par exemple que vous avez vues en cours d'apprentissage sur données bio, où celles utilisées par M. Laurençon).
  

